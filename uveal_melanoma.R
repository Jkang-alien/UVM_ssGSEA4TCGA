#untar('gdac.broadinstitute.org_UVM.Clinical_Pick_Tier1.Level_4.2016012800.0.0.tar.gz', exdir = '.')

#untar('gdac.broadinstitute.org_UVM.Merge_Clinical.Level_1.2016012800.0.0.tar.gz', exdir = '.')

#untar('gdac.broadinstitute.org_UVM.Merge_rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level_3.2016012800.0.0.tar.gz', exdir = '.')

#untar('gdac.broadinstitute.org_UVM-TP.Aggregate_AnalysisFeatures.Level_4.2015082100.0.0.tar.gz', exdir = '.')

#untar('gdac.broadinstitute.org_UVM-TP.CopyNumber_Gistic2.Level_4.2015082100.0.0.tar.gz', exdir = '.')
library('RTCGAToolbox')
library('Cairo')
library('dplyr')
library(survival)
library(rms)

data <- read.delim('./gdac.broadinstitute.org_UVM-TP.Aggregate_AnalysisFeatures.Level_4.2015082100.0.0/UVM-TP.transferedsamplefeatures.txt')

data[1:5,1:5]
data_gdac <- t(data[,-1])
colnames(data_gdac) <- data[,1]
rownames(data_gdac) <- colnames(data)[-1]
data <- data.frame(data_gdac[-dim(data_gdac)[1],])

data[, c(1:4, 15:250)] <- sapply(data[, c(1:4, 15:250)], as.character)

data[, c(1:4, 15:250)] <- sapply(data[, c(1:4, 15:250)], as.numeric)
data$ID <- rownames(data)

summary(data)
colnames(data)

ID_3pDel <- data$ID[data$CN_3p_Del <= -0.2]
ID_3pNor <- data$ID[data$CN_3p_Del > -0.2]



########### Cluster CN NMF ##########################################

################# RNA for GSEA ######################################
############http://www.hammerlab.org/################################

getFirehoseDatasets()
getFirehoseRunningDates(last = NULL)
readData = getFirehoseData (dataset="UVM", runDate="20151101",forceDownload = TRUE,
                            Clinic=TRUE, Mutation=FALSE, Methylation=FALSE, RNAseq2_Gene_Norm=TRUE)

#clin = getData(readData, "Clinical")
mRNA <- getData(readData, 'RNASeq2GeneNorm')

colnames(mRNA) <- gsub('-...-...-....-..', '', colnames(mRNA))
colnames(mRNA) <- gsub('-', '\\.', colnames(mRNA))
colnames(mRNA)

data_GSEA <- c()
data_GSEA <- cbind(mRNA[, colnames(mRNA) %in% ID_3pDel],
                   mRNA[, colnames(mRNA) %in% ID_3pNor])

GSEA <- data.frame(NAME = rownames(data_GSEA), 
                   DESCRIPTION = rep('na', dim(data_GSEA)[1]), data_GSEA)
cls <- c(rep(0, length(ID_3pDel)),
         rep(1, length(ID_3pNor)))

write.table(GSEA, file = 'data.txt', append = FALSE, 
            quote = FALSE, sep = '\t',
            row.names = FALSE,
            col.names = TRUE 
)

write(cls, file = 'cls.cls', append = FALSE, 
      #quote = FALSE, 
      sep = '\t',
      #row.names = FALSE,
      #col.names = TRUE, 
      ncolumns = length(cls)
)

############# mRNA expression comparison #################
log_TSLP <- log(mRNA[rownames(mRNA) == 'TSLP', ])

immune_mRNA <- data.frame(ID = colnames(mRNA),
                          TSLP = as.numeric(mRNA[rownames(mRNA) == 'TSLP', ]),
                          TNFSF4 = as.numeric(mRNA[rownames(mRNA) == 'TNFSF4', ]),
                          #TSLPR = as.numeric(mRNA[rownames(mRNA) == 'TSLPR', ]),
                          GATA3 = as.numeric(mRNA[rownames(mRNA) == 'GATA3', ]),
                          TBX21 = as.numeric(mRNA[rownames(mRNA) == 'TBX21', ]),
                          IFNG = as.numeric(mRNA[rownames(mRNA) == 'IFNG', ]),
                          IL1B = as.numeric(mRNA[rownames(mRNA) == 'IL1B', ]),
                          TNF = as.numeric(mRNA[rownames(mRNA) == 'TNF', ]),
                          IL12A = as.numeric(mRNA[rownames(mRNA) == 'IL12A', ]),
                          IL12B = as.numeric(mRNA[rownames(mRNA) == 'IL12B', ]),
                          IL10 = as.numeric(mRNA[rownames(mRNA) == 'IL10', ]),
                          IL6 = as.numeric(mRNA[rownames(mRNA) == 'IL6', ]),
                          IL13 = as.numeric(mRNA[rownames(mRNA) == 'IL13', ]),
                          CD80 = as.numeric(mRNA[rownames(mRNA) == 'CD80', ]),
                          CCL17 = as.numeric(mRNA[rownames(mRNA) == 'CCL17', ]),
                          CCL22 = as.numeric(mRNA[rownames(mRNA) == 'CCL22', ]))

immune_mRNA$Del3p <- immune_mRNA$ID %in% ID_3pDel

CairoPDF(file = './Figures/boxplots', width = 12, height = 12,
         font = 10)
par(mfrow = c(4,4))

for (i in 2:16){
  boxplot(immune_mRNA[,i] ~ immune_mRNA$Del3p,
  main = colnames(immune_mRNA)[i],
  ylim = c(0, 200),
  names = c('3pNor', '3pDel'))
} 

dev.off()

CairoPDF(file = './Figures/GATA_TBX21.pdf', width = 6, height = 6,
         font = 10)
par(mfrow = c(1,1))

plot(immune_mRNA$TBX21, immune_mRNA$GATA3, 
     col = immune_mRNA$Del3p + 1,
     xlab = 'TBX21 mRNA expression (RSEM)',
     ylab = 'GATA3 mRNA expression (RSEM)'
     )

#abline (h= 10)
#abline (v = 10)

legend(70, 40, c('3pNor', '3pDel'),
       pch = 1,
       col = c(1,2),
       bty = "0")

legend(70, 20, 'Correlation coefficient: 0.82',
       bty = "n")

#abline(0, 1.2)

dev.off()


CairoPDF(file = './Figures/Th2.pdf', width = 12, height = 6,
         font = 10)
par(mfrow = c(1,2))
plot(immune_mRNA$TSLP, immune_mRNA$GATA3,
     col = immune_mRNA$Del3p + 1,
     xlab = 'TSLP mRNA expression (RSEM)',
     ylab = 'GATA3 mRNA expression (RSEM)')
legend(70, 80, c('3pNor', '3pDel'),
       pch = 1,
       col = c(1,2),
       bty = "0")
legend(70, 60, 'Correlation coefficient: -0.15',
       bty = "n")

plot(immune_mRNA$GATA3, immune_mRNA$TNFSF4,
     col = immune_mRNA$Del3p + 1,
     xlab = 'GATA3 mRNA expression (RSEM)',
     ylab = 'TNFSF4 mRNA expression (RSEM)')
legend(40, 30, c('3pNor', '3pDel'),
       pch = 1,
       col = c(1,2),
       bty = "0")
legend(40, 10, 'Correlation coefficient: 0.84',
       bty = "n")

dev.off()

cor(immune_mRNA$GATA3, immune_mRNA$TSLP)

immune_mRNA$ratio_GATA3_TBX21 <- round(immune_mRNA$GATA3/immune_mRNA$TBX21, digits = 2)
clin <- getData(readData, 'Clinical')
clin$months_surv <- clin$days_to_death
clin$months_surv[is.na(clin$days_to_death)] <- clin$days_to_last_followup[is.na(clin$days_to_death)]
clin$ID <- toupper(rownames(clin))
clin$OS_M <- round(as.numeric(clin$months_surv)/30.4, digits = 1)
#clin$f_ratio_GATA3_TBX21 <- factor(clin$ratio_GATA3_TBX21 > 0.8)

library(survival)
library(rms)


data_clin <- merge(clin, immune_mRNA, by = 'ID', all.y = TRUE)
data_clin$f_ratio_GATA3_TBX21 <- factor(data_clin$ratio_GATA3_TBX21 > 1.2)
data_subset <- data_clin %>%
    filter(Del3p == TRUE )

strata <- c('ratio GATA/TBX21 > 1.2',
            'ratio GATA/TBX21 <= 1.2')
library(Cairo)

CairoPDF(file = "./Figures/Survival.pdf",  width = 5, height = 5, 
         onefile = TRUE, bg = "transparent",
         pointsize = 12)
par(
  #mfrow = c(1,2), 
  mar=c(6,4,2,6), mgp = c(2, 1, 0))


fit = npsurv(Surv(OS_M, vital_status == 1)~data_subset$GATA3 > 40,
               data = data_subset)
fit

diff = survdiff(Surv(OS_M, vital_status == 1)~data_subset$GATA3 > 40,
                data = data_subset)
diff

survplot(fit,
         time.inc = 12,
         xlab = 'Months',
         lty = c(1:2),
         conf="none", add=FALSE, 
         label.curves=FALSE, abbrev.label=FALSE,
         levels.only=TRUE, lwd=par('lwd'),
         col=1, col.fill=gray(seq(.95, .75, length=5)),
         loglog=FALSE,n.risk=FALSE,logt=FALSE,
         dots=FALSE,
         grid=FALSE,
         srt.n.risk=0, sep.n.risk=0.04, adj.n.risk=0.3, 
         y.n.risk=-0.2, cex.n.risk=0.6, pr=FALSE       
)

legend(10, 0.2, strata, lty = c(1:2), cex = 0.8,
       xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,
       trace = TRUE,
       bty = 'n')

legend(10, 0.1, 'P-value = 0.412', cex = 0.8,
       xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,
       trace = TRUE,
       bty = 'n')

dev.off()

cox <- coxph(Surv(OS_M, vital_status == 1)~(data_subset$GATA3>10)+(data_subset$TBX21>10),
      data = data_subset)
sink('./Figures/stastics.txt')
coxph(Surv(OS_M, vital_status == 1)~(data_subset$GATA3>10)+(data_subset$TBX21>10),
      data = data_subset)
sink()
